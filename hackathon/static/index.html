<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Watchlist Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-css-reset/dist/reset.min.css" />
    <style>
      :root {
        --bg: #0f172a;      /* slate-900 */
        --bg-2: #0b1220;    /* darker variant */
        --card: #111827;    /* gray-800 */
        --border: #334155;  /* slate-700 */
        --text: #e5e7eb;    /* gray-200 */
        --muted: #94a3b8;   /* slate-400 */
        --accent: #60a5fa;  /* blue-400 */
        --pos: #22c55e;     /* green-500 */
        --neg: #ef4444;     /* red-500 */
        --shadow: rgba(0,0,0,0.35);
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      .container { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
      h1 { font-size: 20px; margin-bottom: 12px; }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 16px;
        box-shadow: 0 4px 12px var(--shadow);
      }
      .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
      input, select {
        height: 34px; border-radius: 10px; border:1px solid var(--border); background: var(--bg-2); color:var(--text); padding: 0 12px;
        transition: border-color .2s ease, box-shadow .2s ease;
      }
      input:focus, select:focus { outline: none; border-color:#475569; box-shadow: 0 0 0 2px rgba(96,165,250,0.2); }
      /* Buttons: no border by default; show subtle box on hover */
      button {
        height: 34px; border-radius: 10px; border: none; padding: 0 14px; cursor:pointer; color:var(--text);
        background: transparent;
        transition: border-color .15s ease, background-color .15s ease;
      }
      button:hover { background-color: #111827; border: 1px solid var(--border); }
      button:active { background-color: #0f172a; }
      button:disabled { opacity:.6; cursor:not-allowed; }
      button.danger { color: var(--neg); }
      table { width:100%; border-collapse: collapse; font-size: 14px; }
      th, td { border-bottom:1px solid var(--border); padding: 10px; text-align: left; }
      th { color:var(--muted); font-weight: 600; }
      tr:hover td { background: #0f172a; }
      .pos { color:var(--pos); font-weight: 600; }
      .neg { color:var(--neg); font-weight: 600; }
      .symbol { font-weight: 700; letter-spacing: .2px; }
      .details { background: var(--bg-2); border:1px dashed var(--border); margin-top:8px; border-radius:10px; padding: 12px; }
      .metric { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; }
      .metric div { background: var(--bg-2); border:1px solid var(--border); border-radius:10px; padding:10px; box-shadow: 0 2px 6px var(--shadow); }
      .chart-wrap { position: relative; height: 260px; }
      .chart-wrap.small { height: 180px; }
      .muted { color:var(--muted); }
      .tiny { font-size: 12px; }
      .actions { display:flex; gap:6px; }
      .controls { display:flex; gap:8px; align-items:center; margin: 8px 0; }
      /* tabs */
      .tabs { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
      .tab { background: transparent; border:none; border-radius:999px; height:32px; padding:0 14px; cursor:pointer; color:var(--text); }
      .tab:hover { background-color: #111827; }
      .tab.active { background-color: #1f2937; }
      .help-link { cursor: pointer; text-decoration: underline; color:var(--muted); }
      .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:flex; align-items:center; justify-content:center; z-index:50; }
      .modal-content { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; max-width:640px; width:92%; color:var(--text); box-shadow: 0 4px 12px var(--shadow); }
      .modal-content h3 { margin:0 0 8px 0; font-size:16px; }
      .modal-content .muted { color:var(--muted); }
      .modal-actions { display:flex; justify-content:flex-end; margin-top:12px; }
      .modal-actions button { height:28px; }
     </style>
     <!-- React & Babel CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Chart.js & time adapter & zoom plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
    <!-- Chart.js plugins: Treemap & Sankey (for advanced visuals) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-sankey@0.12.0"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      const API_BASE = '';

      function fmtNum(n, digits = 2) {
        if (n === null || n === undefined || Number.isNaN(n)) return '-';
        const v = Number(n);
        return v.toLocaleString(undefined, { minimumFractionDigits: digits, maximumFractionDigits: digits });
      }
      function fmtPct(n) {
        if (n === null || n === undefined || Number.isNaN(n)) return '-';
        const v = Number(n);
        return `${v >= 0 ? '+' : ''}${v.toFixed(2)}%`;
      }

      // Chart.js 全局默认颜色适配深色主题
      try {
        Chart.defaults.color = '#e5e7eb';
        Chart.defaults.borderColor = '#334155';
      } catch (e) { /* ignore if Chart not loaded */ }

      // 指标帮助内容映射（简要定义与意义）
      const HELP_MAP = {
        pe: { title:'PE (TTM)', def:'Price-to-Earnings using trailing twelve months EPS; indicates market pricing of earnings.', meaning:'Higher PE can imply stronger growth expectations but may be expensive; compare with sector and growth.' },
        forward_pe: { title:'Forward PE', def:'Price-to-Earnings using next year expected EPS.', meaning:'Emphasizes future profitability; suitable for growth comparisons.' },
        ps: { title:'PS (TTM)', def:'Price-to-Sales using trailing twelve months revenue; useful for companies with unstable or negative profits.', meaning:'Lower PS may indicate better value; assess margins and growth.' },
        pb: { title:'PB', def:'Price-to-Book ratio: price divided by book value per share.', meaning:'Useful for asset-heavy sectors; very low PB may indicate value but check asset quality.' },
        peg: { title:'PEG', def:'PE divided by earnings growth.', meaning:'PEG around 1 is often fair; much higher may be expensive.' },
        beta: { title:'Beta', def:'Relative volatility versus market.', meaning:'Beta>1 more volatile/risky; Beta<1 more stable.' },
        dividend_yield: { title:'Dividend Yield', def:'Annual dividend as a percentage of price.', meaning:'Useful for income investing; watch sustainability.' },
        payout_ratio: { title:'Payout Ratio', def:'Dividends as a percentage of net income.', meaning:'Too high may be unsustainable; consider cash flow and reinvestment needs.' },
        gross_margins: { title:'Gross Margin', def:'Gross profit as a percentage of revenue.', meaning:'Higher is favorable; monitor trend and sector comparison.' },
        operating_margins: { title:'Operating Margin', def:'Operating income as a percentage of revenue.', meaning:'Higher indicates better efficiency; consider expense ratio and scale effects.' },
        profit_margins: { title:'Net Margin', def:'Net income as a percentage of revenue.', meaning:'Higher often means better profitability; watch one-offs and sustainability.' },
        roe: { title:'ROE', def:'Return on Equity: net income over shareholders’ equity.', meaning:'Measures capital return efficiency; persistently high ROE is a positive.' },
        roa: { title:'ROA', def:'Return on Assets: net income over total assets.', meaning:'Measures asset use efficiency; good for cross-sector comparison.' },
        // 财务快照
        revenue: { title:'Revenue', def:'Operating revenue in the reporting period.', meaning:'Track growth rate and mix changes (region/product).' },
        gross_profit: { title:'Gross Profit', def:'Revenue minus cost of goods sold.', meaning:'Analyze with gross margin for competitiveness and cost control.' },
        operating_income: { title:'Operating Income', def:'Profit from operations (including SG&A).', meaning:'Reflects operating efficiency and scale effects.' },
        net_income: { title:'Net Income', def:'Final profit after taxes and non-recurring items.', meaning:'Focus on sustainability and cash flow alignment.' },
        assets: { title:'Assets', def:'Total economic resources owned or controlled.', meaning:'Watch asset mix and turnover efficiency.' },
        liabilities: { title:'Liabilities', def:'Debts and obligations owed externally.', meaning:'High leverage raises risk; assess coverage and solvency.' },
        equity: { title:'Shareholders\' Equity', def:'Residual interest: assets minus liabilities.', meaning:'Equity growth signals internal growth and value creation.' },
        operating_cash_flow: { title:'Operating Cash Flow', def:'Net cash flow from core operations.', meaning:'Match with net income to judge earnings quality.' },
        capital_expenditures: { title:'Capital Expenditures', def:'Spending on long-term assets.', meaning:'High CAPEX needs ROI scrutiny and free cash flow support.' },
        free_cash_flow: { title:'Free Cash Flow', def:'Operating cash flow minus CAPEX.', meaning:'Cash available for dividends, buybacks, and reinvestment.' },
      };
      function App() {
        const [symbols, setSymbols] = useState([]);
        const [prices, setPrices] = useState({});
        const [input, setInput] = useState('');
        const [expanded, setExpanded] = useState(new Set());
        const [history, setHistory] = useState({});
        const [params, setParams] = useState({}); // {SYM: {period, interval}}
        const chartsRef = useRef({}); // {SYM: {price, indicator}}
        const timersRef = useRef({}); // {SYM: {intervalId, backoffTimer}}
        const historyCacheRef = useRef({}); // {SYM: {key: {data, ts}}}
        const inflightRef = useRef({}); // {SYM: boolean}
        const backoffRef = useRef({}); // {SYM: {ms, timer}}
        // tabs
        const [tab, setTab] = useState('watchlist');
        const [hot, setHot] = useState([]);
        const [indices, setIndices] = useState([]);
        const [idxExpanded, setIdxExpanded] = useState(new Set());
        const [idxConPrices, setIdxConPrices] = useState({});
        const [idxCat, setIdxCat] = useState('global'); // indices category: 'global' | 'sector_etf'
 const [infoExpanded, setInfoExpanded] = useState(new Set());
          const [companyData, setCompanyData] = useState({});
          const [showHelp, setShowHelp] = useState(false);
          const [helpKey, setHelpKey] = useState(null);
          const openHelp = (key) => { setHelpKey(key); setShowHelp(true); };
          const closeHelp = () => setShowHelp(false);

          // 投资组合状态与引用
          const [portfolio, setPortfolio] = useState([]);
          const [pfSymbol, setPfSymbol] = useState('');
          const [pfQty, setPfQty] = useState('');
          const [portfolioPrices, setPortfolioPrices] = useState({});
          const [pfAnalysis, setPfAnalysis] = useState(null);
          const pfChartRef = useRef(null);
          // Dashboard chart refs
          const pfTreemapRef = useRef(null);
          const pfRadarRef = useRef(null);
          const pfStackedRef = useRef(null);
          const [pfAiLoading, setPfAiLoading] = useState(false);
          // 提醒功能状态
          const [alertThreshold, setAlertThreshold] = useState(3); // %
          const [alertSound, setAlertSound] = useState(true);
          const [alerts, setAlerts] = useState([]);
          const alertedRef = useRef(new Set());
          
          // AI分析结果缓存
          const [aiAnalyses, setAiAnalyses] = useState({});

          const requestAiAnalysis = async (s) => {
            try {
              const p = prices[s] || {};
              const payload = {
                symbol: s,
                financial_data: {
                  currentPrice: p.price,
                  changePercent: p.change_percent,
                  peRatio: p?.fundamentals?.pe, // 可能没有，后端会处理 N/A
                  rsi14: p?.indicators?.rsi14,
                },
              };
              const r = await fetch(`${API_BASE}/api/ai_analysis`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
              });
              const j = await r.json();
              if (!r.ok) throw new Error(j?.error || 'AI analysis request failed');
              setAiAnalyses(prev => ({ ...prev, [s]: j.analysis || 'No content' }));
            } catch (e) {
              setAiAnalyses(prev => ({ ...prev, [s]: `AI analysis temporarily unavailable: ${e.message || e}` }));
            }
          };

        // Load watchlist
        const loadWatchlist = async () => {
          const r = await fetch(`${API_BASE}/api/watchlist`);
          const j = await r.json();
          setSymbols(j.symbols || []);
        };
        // Poll prices
        const loadPrices = async () => {
          try {
            const r = await fetch(`${API_BASE}/api/prices`);
            const j = await r.json();
            const map = {};
            for (const item of (j.results || [])) map[item.symbol] = item;
            setPrices(map);
            // 检查大幅波动并触发提醒
            try {
              const thr = Number(alertThreshold) || 0;
              if (thr > 0) {
                const newAlerts = [];
                for (const s of (symbols || [])) {
                  const chg = map[s]?.change_percent;
                  if (chg !== undefined && chg !== null && Math.abs(chg) >= thr) {
                    if (!alertedRef.current.has(s)) {
                      alertedRef.current.add(s);
                      newAlerts.push({ symbol: s, change_percent: chg, ts: Date.now() });
                    }
                  } else {
                    // 波动恢复到阈值以内，允许未来再次提醒
                    alertedRef.current.delete(s);
                  }
                }
                if (newAlerts.length) {
                  setAlerts(prev => [...newAlerts, ...prev].slice(0, 10));
                  if (alertSound) beep();
                }
              }
            } catch (e) { /* 忽略提醒计算错误 */ }
          } catch (e) { console.error('prices error', e); }
        };
        useEffect(() => {
          loadWatchlist();
          loadPrices();
          const t = setInterval(loadPrices, 15000);
          return () => clearInterval(t);
        }, []);

        // Add/remove symbol
        const addSymbol = async () => {
          const sym = (input || '').trim().toUpperCase();
          if (!sym) return;
          try {
            const r = await fetch(`${API_BASE}/api/watchlist`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ symbol: sym }) });
            const j = await r.json();
            setSymbols(j.symbols || []);
            setInput('');
            loadPrices();
          } catch (e) { console.error('add error', e); }
        };
        const addSymbolDirect = async (sym) => {
          const s = (sym || '').trim().toUpperCase();
          if (!s) return;
          try {
            const r = await fetch(`${API_BASE}/api/watchlist`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ symbol: s }) });
            const j = await r.json();
            setSymbols(j.symbols || []);
            loadPrices();
          } catch (e) { console.error('add direct error', e); }
        };
        const removeSymbol = async (s) => {
          try {
            const r = await fetch(`${API_BASE}/api/watchlist/${encodeURIComponent(s)}`, { method:'DELETE' });
            const j = await r.json();
            setSymbols(j.symbols || []);
            const ex = new Set(expanded); ex.delete(s); setExpanded(ex);
            const exInfo = new Set(infoExpanded); exInfo.delete(s); setInfoExpanded(exInfo);
            setCompanyData(prev => { const next = { ...prev }; delete next[s]; return next; });
            // Destroy charts & timers
            const ch = chartsRef.current[s];
            if (ch?.price) { ch.price.destroy(); }
            if (ch?.indicator) { ch.indicator.destroy(); }
            delete chartsRef.current[s];
            const tm = timersRef.current[s];
            if (tm?.intervalId) { clearInterval(tm.intervalId); }
            if (tm?.backoffTimer) { clearTimeout(tm.backoffTimer); }
            delete timersRef.current[s];
            delete backoffRef.current[s];
          } catch (e) { console.error('remove error', e); }
        };

        // Fetch history with cache & backoff
        const fetchHistory = async (s, override = {}, opts = {}) => {
          const p = params[s] || { period:'3y', interval:'1d' };
          const q = { ...p, ...override };
          const key = `${q.period}|${q.interval}`;
          const TTL = 90 * 1000; // 90s
          const now = Date.now();
          const cacheSym = historyCacheRef.current[s] || {};
          const cacheItem = cacheSym[key];
          if (!opts.nocache && cacheItem && (now - cacheItem.ts) < TTL) {
            setParams(prev => ({ ...prev, [s]: q }));
            setHistory(h => ({ ...h, [s]: cacheItem.data }));
            setTimeout(() => { renderPriceChart(s, cacheItem.data); renderIndicatorChart(s, cacheItem.data); }, 0);
            return true;
          }
          if (inflightRef.current[s]) return false;
          inflightRef.current[s] = true;
          try {
            const url = `${API_BASE}/api/history/${encodeURIComponent(s)}?period=${encodeURIComponent(q.period)}&interval=${encodeURIComponent(q.interval)}`;
            const r = await fetch(url);
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            const j = await r.json();
            setParams(prev => ({ ...prev, [s]: q }));
            setHistory(h => ({ ...h, [s]: j }));
            historyCacheRef.current[s] = historyCacheRef.current[s] || {};
            historyCacheRef.current[s][key] = { data: j, ts: Date.now() };
            setTimeout(() => { renderPriceChart(s, j); renderIndicatorChart(s, j); }, 0);
            // reset backoff on success
            const b = backoffRef.current[s];
            if (b) { b.ms = 10000; if (b.timer) { clearTimeout(b.timer); b.timer = null; } }
            return true;
          } catch (e) {
            console.error('history error', e);
            scheduleBackoff(s);
            return false;
          } finally {
            inflightRef.current[s] = false;
          }
        };

        const scheduleBackoff = (s) => {
          const current = backoffRef.current[s] || { ms: 10000, timer: null };
          if (current.timer) return; // already scheduled
          const ms = current.ms;
          current.timer = setTimeout(() => {
            current.timer = null;
            fetchHistory(s, {}, { nocache: true });
          }, ms);
          current.ms = Math.min(ms * 2, 5 * 60 * 1000);
          backoffRef.current[s] = current;
        };

        const chartCommonOpts = {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color:'#e5e7eb' } },
            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${fmtNum(ctx.parsed.y)}` } },
            zoom: {
              zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
              pan: { enabled: true, mode: 'x' },
            },
          },
          scales: {
            x: { type: 'time', time: { unit: 'day' }, ticks: { color:'#9ca3af' }, grid: { color:'#1f2937' } },
            y: { ticks: { color:'#9ca3af' }, grid: { color:'#1f2937' } },
          },
        };

        // RSI band shading plugin
        const rsiBandPlugin = {
          id: 'rsiBandPlugin',
          beforeDatasetsDraw(chart) {
            const { ctx, chartArea, scales } = chart;
            if (!chartArea) return;
            const xLeft = chartArea.left;
            const width = chartArea.right - chartArea.left;
            const y = scales.y;
            const y0 = y.getPixelForValue(0);
            const y30 = y.getPixelForValue(30);
            const y70 = y.getPixelForValue(70);
            const y100 = y.getPixelForValue(100);
            const rect = (ya, yb) => ({ top: Math.min(ya, yb), h: Math.abs(ya - yb) });
            // Overbought (70-100) red tint
            const r1 = rect(y70, y100);
            ctx.save();
            ctx.fillStyle = 'rgba(239,68,68,0.08)';
            ctx.fillRect(xLeft, r1.top, width, r1.h);
            // Oversold (0-30) green tint
            const r2 = rect(y0, y30);
            ctx.fillStyle = 'rgba(34,197,94,0.08)';
            ctx.fillRect(xLeft, r2.top, width, r2.h);
            ctx.restore();
          },
        };

        const attachDblClickReset = (canvas, s, chartKey) => {
          if (!canvas) return;
          const handler = () => {
            const ch = chartsRef.current[s]?.[chartKey];
            if (ch?.resetZoom) ch.resetZoom();
          };
          // remove then add to avoid duplicate
          canvas.removeEventListener('dblclick', handler);
          canvas.addEventListener('dblclick', handler);
        };

        const renderPriceChart = (s, data) => {
          try {
            const el = document.getElementById(`chart-price-${s}`);
            if (!el) return;
            // Destroy old
            const old = chartsRef.current[s]?.price;
            if (old) old.destroy();
            const ctx = el.getContext('2d');
            const ts = data.ts || [];
            const close = data.close || [];
            const sma20 = (data.indicators && data.indicators.sma20) || [];
            const sma50 = (data.indicators && data.indicators.sma50) || [];
            const bb = (data.indicators && data.indicators.bbands) || {};
            const upper = bb.upper || [];
            const lower = bb.lower || [];
            const middle = bb.middle || [];

            const cfg = {
              type: 'line',
              data: {
                labels: ts,
                datasets: [
                  { label:'Close', data: close, borderColor:'#3b82f6', backgroundColor:'transparent', pointRadius:0, borderWidth:1.6 },
                  { label:'SMA20', data: sma20, borderColor:'#f59e0b', backgroundColor:'transparent', pointRadius:0, borderWidth:1.2 },
                  { label:'SMA50', data: sma50, borderColor:'#f97316', backgroundColor:'transparent', pointRadius:0, borderWidth:1.2 },
                  { label:'BB Upper', data: upper, borderColor:'#9ca3af', backgroundColor:'transparent', pointRadius:0, borderWidth:1, borderDash:[4,3] },
                  { label:'BB Middle', data: middle, borderColor:'#6b7280', backgroundColor:'transparent', pointRadius:0, borderWidth:0.8, borderDash:[3,3] },
                  { label:'BB Lower', data: lower, borderColor:'#9ca3af', backgroundColor:'transparent', pointRadius:0, borderWidth:1, borderDash:[4,3] },
                ],
              },
              options: chartCommonOpts,
            };
            chartsRef.current[s] = chartsRef.current[s] || {};
            chartsRef.current[s].price = new Chart(ctx, cfg);
            attachDblClickReset(el, s, 'price');
          } catch (e) { console.error('price chart render error', e); }
        };

        const renderIndicatorChart = (s, data) => {
          try {
            const el = document.getElementById(`chart-ind-${s}`);
            if (!el) return;
            // Destroy old
            const old = chartsRef.current[s]?.indicator;
            if (old) old.destroy();
            const ctx = el.getContext('2d');
            const ts = data.ts || [];
            const rsi = (data.indicators && data.indicators.rsi14) || [];
            const macd = (data.indicators && data.indicators.macd) || {};
            const macdLine = macd.macd || [];
            const signal = macd.signal || [];
            const hist = macd.hist || [];
            const rsi30 = Array(ts.length).fill(30);
            const rsi70 = Array(ts.length).fill(70);

            const cfg = {
              type: 'line',
              data: {
                labels: ts,
                datasets: [
                  { label:'RSI14', data: rsi, borderColor:'#22c55e', backgroundColor:'transparent', pointRadius:0, borderWidth:1.2 },
                  { label:'RSI 70', data: rsi70, borderColor:'#ef4444', backgroundColor:'transparent', pointRadius:0, borderWidth:0.8, borderDash:[4,3] },
                  { label:'RSI 30', data: rsi30, borderColor:'#22c55e', backgroundColor:'transparent', pointRadius:0, borderWidth:0.8, borderDash:[4,3] },
                  { label:'MACD', data: macdLine, borderColor:'#eab308', backgroundColor:'transparent', pointRadius:0, borderWidth:1.2 },
                  { label:'Signal', data: signal, borderColor:'#facc15', backgroundColor:'transparent', pointRadius:0, borderWidth:1.0 },
                  {
                    label:'Hist',
                    data: hist,
                    type:'bar',
                    backgroundColor: (ctx) => {
                      const v = ctx.parsed?.y ?? 0;
                      return v >= 0 ? 'rgba(34,197,94,0.6)' : 'rgba(239,68,68,0.6)';
                    },
                    borderWidth: 0,
                  },
                ],
              },
              options: {
                ...chartCommonOpts,
                scales: {
                  x: chartCommonOpts.scales.x,
                  y: { ...chartCommonOpts.scales.y, suggestedMin: -100, suggestedMax: 100 },
                },
              },
              plugins: [rsiBandPlugin],
            };
            chartsRef.current[s] = chartsRef.current[s] || {};
            chartsRef.current[s].indicator = new Chart(ctx, cfg);
            attachDblClickReset(el, s, 'indicator');
          } catch (e) { console.error('indicator chart render error', e); }
        };

        const toggleDetails = (s) => {
          const ex = new Set(expanded);
          if (ex.has(s)) {
            ex.delete(s);
            // stop auto refresh & backoff
            const tm = timersRef.current[s];
            if (tm?.intervalId) { clearInterval(tm.intervalId); }
            if (tm?.backoffTimer) { clearTimeout(tm.backoffTimer); }
            delete timersRef.current[s];
            const b = backoffRef.current[s];
            if (b?.timer) clearTimeout(b.timer);
            delete backoffRef.current[s];
          } else {
            ex.add(s);
            // fetch & render (cache-aware)
            fetchHistory(s);
            // start auto refresh every 60s, backoff managed separately
            const intervalId = setInterval(() => fetchHistory(s), 60000);
            timersRef.current[s] = { intervalId, backoffTimer: null };
            backoffRef.current[s] = { ms: 10000, timer: null };
          }
          setExpanded(ex);
        };

        const onParamChange = (s, next) => {
          setParams(prev => ({ ...prev, [s]: { ...(prev[s] || { period:'3y', interval:'1d' }), ...next } }));
          // refetch with overrides
          fetchHistory(s, next);
        };

        const resetZoomAll = (s) => {
          const ch = chartsRef.current[s] || {};
          if (ch.price?.resetZoom) ch.price.resetZoom();
          if (ch.indicator?.resetZoom) ch.indicator.resetZoom();
        };

        const fetchCompany = async (s) => {
          try {
            const r = await fetch(`${API_BASE}/api/company/${encodeURIComponent(s)}`);
            const j = await r.json();
            setCompanyData(prev => ({ ...prev, [s]: j }));
          } catch (e) { console.error('company error', e); }
        };

        const toggleInfo = async (s) => {
          const ex = new Set(infoExpanded);
          if (ex.has(s)) { ex.delete(s); setInfoExpanded(ex); return; }
          ex.add(s); setInfoExpanded(ex);
          await fetchCompany(s);
        };

        // Tabs: loaders and toggles
        const loadHot = async () => {
          try {
            const r = await fetch(`${API_BASE}/api/hot`);
            const j = await r.json();
            setHot(j.results || []);
          } catch (e) { console.error('hot error', e); }
        };
        const loadIndices = async () => {
          try {
            const r = await fetch(`${API_BASE}/api/indices?category=${encodeURIComponent(idxCat)}`);
            const j = await r.json();
            setIndices(j.indices || []);
          } catch (e) { console.error('indices error', e); }
        };
        const switchTab = (t) => {
          setTab(t);
          if (t === 'hot') loadHot();
          if (t === 'indices') loadIndices();
        };
        useEffect(() => {
          if (tab === 'indices') loadIndices();
        }, [idxCat, tab]);
        const toggleIdxExpand = async (idxSym, constituents) => {
          const ex = new Set(idxExpanded);
          if (ex.has(idxSym)) {
            ex.delete(idxSym);
            setIdxExpanded(ex);
            return;
          }
          ex.add(idxSym);
          setIdxExpanded(ex);
          try {
            const qs = constituents.join(',');
            const r = await fetch(`${API_BASE}/api/prices?symbols=${encodeURIComponent(qs)}`);
            const j = await r.json();
            const map = {};
            for (const item of (j.results || [])) map[item.symbol] = item;
            setIdxConPrices(prev => ({ ...prev, [idxSym]: map }));
          } catch (e) { console.error('constituents prices error', e); }
        };

        // 投资组合：添加/移除持仓、价格获取、饼图渲染
        const addHolding = async () => {
          const sym = (pfSymbol || '').trim().toUpperCase();
          const qty = parseFloat(pfQty);
          if (!sym || !isFinite(qty) || qty <= 0) return;
          setPortfolio(prev => {
            const existing = prev.find(x => x.symbol === sym);
            if (existing) {
              return prev.map(x => x.symbol === sym ? { ...x, quantity: x.quantity + qty } : x);
            }
            return [...prev, { symbol: sym, quantity: qty }];
          });
          setPfSymbol('');
          setPfQty('');
          await updatePortfolioPrices([sym]);
        };

        const removeHolding = (sym) => {
          setPortfolio(prev => prev.filter(x => x.symbol !== sym));
          if (pfChartRef.current) { pfChartRef.current.destroy(); pfChartRef.current = null; }
          if (pfTreemapRef.current) { try { pfTreemapRef.current.destroy(); } catch(e){} pfTreemapRef.current = null; }
          if (pfStackedRef.current) { try { pfStackedRef.current.destroy(); } catch(e){} pfStackedRef.current = null; }
          // 雷达图依赖 pfAnalysis，会在依赖变化时刷新
        };

        const updatePortfolioPrices = async (symbols = []) => {
          try {
            const syms = symbols.length ? symbols : [...new Set(portfolio.map(x => x.symbol))];
            if (syms.length === 0) return;
            const qs = syms.join(',');
            const r = await fetch(`${API_BASE}/api/prices?symbols=${encodeURIComponent(qs)}`);
            const j = await r.json();
            const map = {};
            for (const item of (j.results || [])) map[item.symbol] = item;
            setPortfolioPrices(prev => ({ ...prev, ...map }));
          } catch (e) { console.error('portfolio prices error', e); }
        };

        // 投资组合AI诊断：计算权重并请求后端
        const requestPortfolioDiagnostic = async () => {
          try {
            setPfAiLoading(true);
            setPfAnalysis(null);
            const items = portfolio.map(h => {
              const priceObj = prices[h.symbol] || portfolioPrices[h.symbol] || {};
              const price = priceObj.price || 0;
              const val = price * (h.quantity || 0);
              return { symbol: h.symbol, value: isFinite(val) ? val : 0 };
            });
            const total = items.reduce((a,b)=>a + (b.value||0), 0);
            const holdings = items.map(it => ({ symbol: it.symbol, weight: total > 0 ? (it.value/total) : (items.length ? 1/items.length : 0) }));
            const r = await fetch(`${API_BASE}/api/portfolio/diagnostic`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ holdings })
            });
            const j = await r.json();
            if (j && j.ok) {
              setPfAnalysis({ analysis: j.analysis, summary_text: j.summary_text });
            } else {
              setPfAnalysis({ error: j && j.error ? j.error : 'diagnostic_failed' });
            }
          } catch (e) {
            console.error('portfolio diagnostic error', e);
            setPfAnalysis({ error: String(e) });
          } finally {
            setPfAiLoading(false);
          }
        };

        const renderPortfolioChart = () => {
          try {
            const el = document.getElementById('chart-portfolio');
            if (!el) return;
            const old = pfChartRef.current;
            if (old) old.destroy();
            const ctx = el.getContext('2d');
            const labels = portfolio.map(x => x.symbol);
            const dataVals = portfolio.map(x => {
              const priceObj = prices[x.symbol] || portfolioPrices[x.symbol] || {};
              const price = priceObj.price;
              const v = price ? price * x.quantity : 0;
              return v;
            });
            const colors = ['#3b82f6','#ef4444','#22c55e','#eab308','#f97316','#8b5cf6','#14b8a6','#f43f5e','#10b981','#6366f1'];
            const bg = labels.map((_, i) => colors[i % colors.length]);
            const total = dataVals.reduce((a,b)=>a+b,0) || 1;
            const cfg = {
              type: 'pie',
              data: {
                labels,
                datasets: [{ data: dataVals, backgroundColor: bg, borderColor:'#1f2937', borderWidth:1 }],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { labels: { color:'#e5e7eb' } },
                  tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${fmtNum(ctx.parsed)} (${fmtPct(100*ctx.parsed/total)})` } },
                },
              },
            };
            pfChartRef.current = new Chart(ctx, cfg);
          } catch (e) { console.error('portfolio chart render error', e); }
        };

        useEffect(() => { renderPortfolioChart(); }, [portfolio, portfolioPrices, prices]);
        useEffect(() => { renderRadarChart(); }, [pfAnalysis]);

        // 声音提醒：简单 beep
        const beep = () => {
          try {
            const Ctx = window.AudioContext || window.webkitAudioContext;
            if (!Ctx) return;
            const ctx = new Ctx();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 880;
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.6);
            setTimeout(() => { osc.stop(); ctx.close(); }, 600);
          } catch (e) { /* ignore */ }
        };

        // ======== 仪表板辅助与图表渲染 ========
        const computeValueWeights = () => {
          const items = portfolio.map(h => {
            const priceObj = prices[h.symbol] || portfolioPrices[h.symbol] || {};
            const price = priceObj.price || 0;
            const val = price * (h.quantity || 0);
            return { symbol: h.symbol, value: isFinite(val) ? val : 0 };
          });
          const total = items.reduce((a,b)=>a + (b.value||0), 0);
          return items.map(it => ({ symbol: it.symbol, weight: total > 0 ? (it.value/total) : (items.length ? 1/items.length : 0) }));
        };

        const renderRadarChart = () => {
          try {
            const el = document.getElementById('chart-pf-radar');
            if (!el || !pfAnalysis || pfAnalysis.error) return;
            if (pfRadarRef.current) pfRadarRef.current.destroy();
            const ctx = el.getContext('2d');
            const labels = ['Max Single-Stock Weight', 'Sector Concentration', 'Valuation Exposure'];
            const values = [
              Math.min(1, (pfAnalysis.analysis?.metrics?.single_stock_weight || 0)),
              Math.min(1, (pfAnalysis.analysis?.metrics?.sector_concentration || 0)),
              Math.min(1, ((pfAnalysis.analysis?.metrics?.avg_pe || 0) / 50))
            ];
            pfRadarRef.current = new Chart(ctx, {
              type: 'radar',
              data: { labels, datasets: [{ label: 'Risk Exposure', data: values, fill: true, backgroundColor: 'rgba(37,99,235,0.2)', borderColor: '#2563eb', pointBackgroundColor: '#2563eb' }] },
              options: { responsive: true, scales: { r: { beginAtZero: true, max: 1 } }, plugins: { legend: { display: false } } }
            });
          } catch(e) { console.error('radar render error', e); }
        };

        const renderTreemapChart = () => {
          try {
            const el = document.getElementById('chart-pf-treemap');
            if (!el) return;
            if (pfTreemapRef.current) pfTreemapRef.current.destroy();
            const ctx = el.getContext('2d');
            const weights = computeValueWeights();
            if (!weights.length) {
              ctx.font = '12px sans-serif'; ctx.fillStyle = '#6b7280'; ctx.fillText('No holdings data; cannot render treemap', 8, 18);
              return;
            }
            const data = weights.map(w => ({ label: w.symbol, value: Math.max(0.0001, w.weight) }));
            pfTreemapRef.current = new Chart(ctx, {
              type: 'treemap',
              data: {
                datasets: [{
                  tree: data,
                  key: 'value',
                  groups: ['label'],
                  spacing: 0.5,
                  borderColor: '#334155',
                  borderWidth: 1,
                  fontColor: '#e5e7eb',
                  backgroundColor: (c) => {
                    const v = c.raw ? c.raw.v : 0.2;
                    const hue = 210 - Math.round(120 * v);
                    return `hsl(${hue}, 70%, ${40 - Math.round(20 * v)}%)`;
                  },
                  labels: { display: true, formatter: (c) => `${c.g} ${(c.v*100).toFixed(1)}%` }
                }]
              },
              options: { plugins: { legend: { display: false } } }
            });
          } catch(e) { console.error('treemap render error', e); }
        };

        const renderCorrelationHeatmap = async () => {
          try {
            const container = document.getElementById('pf-heatmap');
            if (!container) return;
            const syms = portfolio.map(p => p.symbol);
            if (syms.length === 0) { container.innerHTML = '<span class="tiny muted">No holdings data</span>'; return; }
            const series = {};
            for (const s of syms) {
              try {
                const r = await fetch(`${API_BASE}/api/history/${encodeURIComponent(s)}?period=3mo&interval=1d`);
                const d = await r.json();
                const closes = (d.prices || []).map(pt => ({ t: pt.date || pt.t || pt.timestamp, c: pt.close }))
                  .filter(pt => pt.t != null && pt.c != null)
                  .sort((a,b)=>a.t-b.t);
                const rets = [];
                for (let i=1;i<closes.length;i++) rets.push({ t: closes[i].t, r: Math.log(closes[i].c / closes[i-1].c) });
                series[s] = rets;
              } catch(e) { series[s] = []; }
            }
            const allTs = Array.from(new Set(Object.values(series).flat().map(x => x.t))).sort((a,b)=>a-b);
            const corr = (a,b) => {
              const xs = allTs.map(t => (a.find(x=>x.t===t)?.r ?? null));
              const ys = allTs.map(t => (b.find(y=>y.t===t)?.r ?? null));
              const pairs = []; for (let i=0;i<xs.length;i++){ if (xs[i]!=null && ys[i]!=null) pairs.push([xs[i],ys[i]]); }
              if (pairs.length < 3) return 0;
              const mx = pairs.reduce((s,p)=>s+p[0],0)/pairs.length; const my = pairs.reduce((s,p)=>s+p[1],0)/pairs.length;
              let num=0,sx=0,sy=0; for (const [x,y] of pairs){ num+=(x-mx)*(y-my); sx+=(x-mx)**2; sy+=(y-my)**2; }
              const den = Math.sqrt(sx*sy); if (!den || !isFinite(den)) return 0; return Math.max(-1, Math.min(1, num/den));
            };
            const N = syms.length; const mat = Array.from({length:N},()=>Array(N).fill(0));
            for (let i=0;i<N;i++) for (let j=0;j<N;j++) mat[i][j] = i===j ? 1 : corr(series[syms[i]]||[], series[syms[j]]||[]);
            const color = (v) => { const hue = 0 + (240)*((v+1)/2); return `hsl(${Math.round(hue)}, 80%, ${50 - 20*Math.abs(v)}%)`; };
            let html = '<table class="table" style="min-width: 420px;">';
            html += '<thead><tr><th></th>' + syms.map(s=>`<th>${s}</th>`).join('') + '</tr></thead><tbody>';
            for (let i=0;i<N;i++) {
              html += `<tr><th>${syms[i]}</th>`;
              for (let j=0;j<N;j++) {
                const v = mat[i][j]; const bg = color(v);
                html += `<td style="background:${bg}; color:#e5e7eb;">${(v).toFixed(2)}</td>`;
              }
              html += '</tr>';
            }
            html += '</tbody></table>';
            container.innerHTML = html;
          } catch(e) { console.error('heatmap render error', e); }
        };

        const renderStackedArea = async () => {
          try {
            const el = document.getElementById('chart-pf-stacked');
            if (!el) return;
            if (pfStackedRef.current) pfStackedRef.current.destroy();
            const ctx = el.getContext('2d');
            if (portfolio.length === 0) { ctx.font='12px sans-serif'; ctx.fillStyle='#6b7280'; ctx.fillText('No holdings data; cannot render trend chart', 8,18); return; }
            const histories = {};
            for (const p of portfolio) {
              try {
                const r = await fetch(`${API_BASE}/api/history/${encodeURIComponent(p.symbol)}?period=3mo&interval=1d`);
                const d = await r.json();
                const closes = (d.prices || []).map(pt => ({ t: pt.date || pt.t || pt.timestamp, c: pt.close }))
                  .filter(pt => pt.t != null && pt.c != null)
                  .sort((a,b)=>a.t-b.t);
                histories[p.symbol] = closes;
              } catch(e) { histories[p.symbol] = []; }
            }
            const allTs = Array.from(new Set(Object.values(histories).flat().map(x=>x.t))).sort((a,b)=>a-b);
            const colors = ['#93c5fd','#86efac','#fca5a5','#fcd34d','#c4b5fd','#67e8f9','#f9a8d4','#a7f3d0'];
            let colorIdx = 0; const datasets = []; const totals = allTs.map(()=>0);
            for (const p of portfolio) {
              const q = p.quantity || 0;
              const data = allTs.map(t => { const pt = histories[p.symbol]?.find(x=>x.t===t); const val = pt? q * pt.c : 0; return { x: t*1000, y: val }; });
              for (let i=0;i<data.length;i++) totals[i] += data[i].y;
              const col = colors[colorIdx++ % colors.length];
              datasets.push({ label: p.symbol, data, borderColor: col, backgroundColor: col + '33', fill: true, tension: 0.2, stack: 'contrib' });
            }
            for (const ds of datasets) ds.data = ds.data.map((pt,i)=>({ x: pt.x, y: totals[i] ? pt.y / totals[i] : 0 }));
            pfStackedRef.current = new Chart(ctx, {
              type: 'line',
              data: { datasets },
              options: { parsing:false, plugins:{ legend:{ position:'bottom' } }, scales:{ x:{ type:'time', time:{ unit:'week' } }, y:{ stacked:true, min:0, max:1 } } }
            });
          } catch(e) { console.error('stacked render error', e); }
        };

        const refreshPortfolioDashboard = async () => {
          renderTreemapChart();
          renderRadarChart();
          await renderCorrelationHeatmap();
          await renderStackedArea();
        };

        const dismissAlert = (idx) => {
          setAlerts(prev => {
            const it = prev[idx];
            if (it?.symbol) alertedRef.current.delete(it.symbol);
            return prev.filter((_, i) => i !== idx);
          });
        };

        

        return (
          <div className="container">
            <h1>Watchlist Dashboard (with charts)</h1>

          <div className="card tabs">
            <button className={`tab ${tab==='watchlist'?'active':''}`} onClick={()=>switchTab('watchlist')}>Watchlist</button>
            <button className={`tab ${tab==='hot'?'active':''}`} onClick={()=>switchTab('hot')}>Hot Stocks</button>
            <button className={`tab ${tab==='indices'?'active':''}`} onClick={()=>switchTab('indices')}>Indices</button>
            <button className={`tab ${tab==='portfolio'?'active':''}`} onClick={()=>switchTab('portfolio')}>Portfolio</button>
          </div>

            {/* Alert Toast list */}
          <div style={{ position:'fixed', right:16, bottom:16, zIndex:50 }}>
            {alerts.map((a, i) => (
              <div key={i} className="card" style={{ padding:'8px 12px', minWidth:220 }}>
            <div><span className="symbol">{a.symbol}</span> Volatility Alert</div>
                <div className={a.change_percent>0?'pos':a.change_percent<0?'neg':''}>{fmtPct(a.change_percent)}</div>
                <div className="tiny muted">{new Date(a.ts).toLocaleTimeString()}</div>
            <div style={{ marginTop:6 }}><button onClick={()=>dismissAlert(i)}>Dismiss</button></div>
              </div>
            ))}
          </div>

            {tab === 'watchlist' && (
              <>
                <div className="card">
                  <div className="row">
            <input value={input} onChange={(e)=>setInput(e.target.value)} placeholder="Symbol, e.g. AAPL" />
            <button onClick={addSymbol}>Add to Watchlist</button>
            <button onClick={loadPrices}>Refresh Now</button>
            <input value={alertThreshold} onChange={(e)=>setAlertThreshold(e.target.value)} placeholder="Alert threshold %, e.g. 3" style={{ width: 120, marginLeft: 8 }} />
                    <label className="tiny muted" style={{ marginLeft: 8 }}>
            <input type="checkbox" checked={alertSound} onChange={(e)=>setAlertSound(e.target.checked)} style={{ marginRight: 6 }} />Sound alert
                    </label>
            <span className="muted tiny">Auto-refresh every 15s</span>
                  </div>
                </div>

                <div className="card">
                  <table>
                    <thead>
                      <tr>
            <th>Symbol</th>
            <th>Price</th>
            <th>Change %</th>
                        <th>SMA20</th>
                        <th>RSI14</th>
            <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {symbols.map((s) => {
                        const p = prices[s] || {};
                        const chgPct = p.change_percent;
                        const cls = chgPct > 0 ? 'pos' : chgPct < 0 ? 'neg' : '';
                        const pms = params[s] || { period:'3y', interval:'1d' };
                        return (
                          <React.Fragment key={s}>
                            <tr>
                              <td className="symbol">{s}</td>
                              <td>{fmtNum(p.price)}</td>
                              <td className={cls}>{fmtPct(chgPct)}</td>
                              <td>{fmtNum(p?.indicators?.sma20)}</td>
                              <td>{fmtNum(p?.indicators?.rsi14)}</td>
                              <td>
                                <div className="actions">
            <button onClick={()=>toggleDetails(s)}>{expanded.has(s) ? 'Collapse' : 'Details'}</button>
            <button onClick={()=>toggleInfo(s)}>{infoExpanded.has(s) ? 'Hide Info' : 'Company Info'}</button>
            <button onClick={()=>requestAiAnalysis(s)}>AI Analysis</button>
            <button onClick={()=>removeSymbol(s)}>Remove</button>
                                </div>
                              </td>
                            </tr>
                            {aiAnalyses[s] && (
                              <tr>
                                <td colSpan="6">
                                  <div className="card" style={{ marginTop: 8 }}>
            <div className="tiny muted">AI Analysis (from backend):</div>
                                    <div style={{ whiteSpace:'pre-wrap' }}>{aiAnalyses[s]}</div>
                                  </div>
                                </td>
                              </tr>
                            )}
                            {expanded.has(s) && (
                              <tr>
                                <td colSpan="6">
                                  <div className="details">
                                    <div className="controls">
                                      <span className="tiny muted">Period:</span>
                                      <select value={pms.period} onChange={(e)=>onParamChange(s, { period: e.target.value })}>
                                        <option value="1y">1y</option>
                                        <option value="2y">2y</option>
                                        <option value="3y">3y</option>
                                        <option value="5y">5y</option>
                                      </select>
                                      <span className="tiny muted">Interval:</span>
                                      <select value={pms.interval} onChange={(e)=>onParamChange(s, { interval: e.target.value })}>
                                        <option value="1d">1d</option>
                                        <option value="1h">1h</option>
                                        <option value="5m">5m</option>
                                      </select>
                                      <button onClick={()=>fetchHistory(s)} style={{ marginLeft: 8 }}>Refresh History</button>
                                      <button onClick={()=>resetZoomAll(s)} style={{ marginLeft: 4 }}>Reset Zoom</button>
                                      <span className="tiny muted">Details auto-refresh every 60s; double-click chart to reset zoom</span>
                                    </div>
                                    <div className="metric">
                                      <div>
                                        <div className="tiny muted">Open</div>
                                        <div>{fmtNum(p.open)}</div>
                                      </div>
                                      <div>
                                        <div className="tiny muted">High</div>
                                        <div>{fmtNum(p.high)}</div>
                                      </div>
                                      <div>
                                        <div className="tiny muted">Low</div>
                                        <div>{fmtNum(p.low)}</div>
                                      </div>
                                      <div>
                                        <div className="tiny muted">Prev Close</div>
                                        <div>{fmtNum(p.prev_close)}</div>
                                      </div>
                                      <div>
                                        <div className="tiny muted">Volume</div>
                                        <div>{fmtNum(p.volume, 0)}</div>
                                      </div>
                                      <div>
                                        <div className="tiny muted">Market Cap</div>
                                        <div>{fmtNum(p.market_cap, 0)}</div>
                                      </div>
                                    </div>
                                    <div style={{ marginTop: 10 }} className="tiny muted">Price / SMA20 / SMA50 / Bollinger Bands</div>
                                    <div className="chart-wrap">
                                      <canvas id={`chart-price-${s}`}></canvas>
                                    </div>
                                    <div style={{ marginTop: 10 }} className="tiny muted">RSI14 (30/70 thresholds, band shading) / MACD (lines) / Histogram (colored by sign)</div>
                                    <div className="chart-wrap small">
                                      <canvas id={`chart-ind-${s}`}></canvas>
                                    </div>
                                  </div>
                                </td>
                              </tr>
                            )}
                            {infoExpanded.has(s) && (
                              <tr>
                                <td colSpan="6">
                                  <div className="details">
                                    <div className="tiny muted">Company Info</div>
                                    <div className="metric" style={{ marginTop: 6 }}>
                                      <div>
                                        <div className="tiny muted">Name</div>
                                        <div>{companyData[s]?.info?.name || '-'}</div>
                                      </div>
                                      <div>
                                        <div className="tiny muted">Industry</div>
                                        <div>{companyData[s]?.info?.industry || '-'}</div>
                                      </div>
                                      <div>
                                        <div className="tiny muted">Sector</div>
                                        <div>{companyData[s]?.info?.sector || '-'}</div>
                                      </div>
                                      <div>
                                        <div className="tiny muted">Market Cap</div>
                                        <div>{fmtNum(companyData[s]?.info?.market_cap, 0)}</div>
                                      </div>
                                      <div>
                                        <div className="tiny muted">Employees</div>
                                        <div>{fmtNum(companyData[s]?.info?.employees, 0)}</div>
                                      </div>
                                      <div>
                                        <div className="tiny muted">Website</div>
                                        <div>{companyData[s]?.info?.website ? <a href={companyData[s].info.website} target="_blank" rel="noopener noreferrer">{companyData[s].info.website}</a> : '-'}</div>
                                      </div>
                                    </div>
                                    <div style={{ marginTop: 8 }}>
                                      <div className="tiny muted">Company Overview</div>
                                      <div className="tiny" style={{ marginTop:4 }}>{companyData[s]?.info?.summary || '—'}</div>
                                    </div>
                                    <div style={{ marginTop: 10 }}>
                                      <div className="tiny muted">Fundamentals</div>
                                      <div className="metric" style={{ marginTop: 6 }}>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('pe')}>PE(TTM)</div>
                                          <div>{fmtNum(companyData[s]?.fundamentals?.pe)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('forward_pe')}>Forward PE</div>
                                          <div>{fmtNum(companyData[s]?.fundamentals?.forward_pe)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('ps')}>PS(TTM)</div>
                                          <div>{fmtNum(companyData[s]?.fundamentals?.ps)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('pb')}>PB</div>
                                          <div>{fmtNum(companyData[s]?.fundamentals?.pb)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('peg')}>PEG</div>
                                          <div>{fmtNum(companyData[s]?.fundamentals?.peg)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('beta')}>Beta</div>
                                          <div>{fmtNum(companyData[s]?.fundamentals?.beta)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('dividend_yield')}>Dividend Yield</div>
                                          <div>{fmtNum((companyData[s]?.fundamentals?.dividend_yield||0)*100)}%</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('payout_ratio')}>Payout Ratio</div>
                                          <div>{fmtNum((companyData[s]?.fundamentals?.payout_ratio||0)*100)}%</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('gross_margins')}>Gross Margin</div>
                                          <div>{fmtNum((companyData[s]?.fundamentals?.gross_margins||0)*100)}%</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('operating_margins')}>Operating Margin</div>
                                          <div>{fmtNum((companyData[s]?.fundamentals?.operating_margins||0)*100)}%</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('profit_margins')}>Net Margin</div>
                                          <div>{fmtNum((companyData[s]?.fundamentals?.profit_margins||0)*100)}%</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('roe')}>ROE</div>
                                          <div>{fmtNum((companyData[s]?.fundamentals?.roe||0)*100)}%</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('roa')}>ROA</div>
                                          <div>{fmtNum((companyData[s]?.fundamentals?.roa||0)*100)}%</div>
                                        </div>
                                      </div>
                                    </div>
                                    <div style={{ marginTop: 10 }}>
                                      <div className="tiny muted">Financial Snapshot (latest)</div>
                                      <div className="metric" style={{ marginTop: 6 }}>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('revenue')}>Revenue</div>
                                          <div>{fmtNum(companyData[s]?.financials?.annual?.revenue, 0)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('gross_profit')}>Gross Profit</div>
                                          <div>{fmtNum(companyData[s]?.financials?.annual?.gross_profit, 0)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('operating_income')}>Operating Income</div>
                                          <div>{fmtNum(companyData[s]?.financials?.annual?.operating_income, 0)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('net_income')}>Net Income</div>
                                          <div>{fmtNum(companyData[s]?.financials?.annual?.net_income, 0)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('assets')}>Assets</div>
                                          <div>{fmtNum(companyData[s]?.financials?.balance_sheet?.assets, 0)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('liabilities')}>Liabilities</div>
                                          <div>{fmtNum(companyData[s]?.financials?.balance_sheet?.liabilities, 0)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('equity')}>Shareholders' Equity</div>
                                          <div>{fmtNum(companyData[s]?.financials?.balance_sheet?.equity, 0)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('operating_cash_flow')}>Operating Cash Flow</div>
                                          <div>{fmtNum(companyData[s]?.financials?.cashflow?.operating_cash_flow, 0)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('capital_expenditures')}>Capital Expenditures</div>
                                          <div>{fmtNum(companyData[s]?.financials?.cashflow?.capital_expenditures, 0)}</div>
                                        </div>
                                        <div>
                                          <div className="tiny muted help-link" onClick={()=>openHelp('free_cash_flow')}>Free Cash Flow</div>
                                          <div>{fmtNum(companyData[s]?.financials?.cashflow?.free_cash_flow, 0)}</div>
                                        </div>
                                      </div>
                                    </div>
                                    {/* 新闻功能已移除 */}
                                  </div>
                                </td>
                              </tr>
                            )}
                              </React.Fragment>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </>
            )}

            {tab === 'portfolio' && (
              <>
                <div className="card">
                  <div className="row">
            <input value={pfSymbol} onChange={(e)=>setPfSymbol(e.target.value)} placeholder="Symbol, e.g. AAPL" />
            <input value={pfQty} onChange={(e)=>setPfQty(e.target.value)} placeholder="Quantity, e.g. 10" />
            <button onClick={addHolding}>Add to Portfolio</button>
            <button onClick={()=>updatePortfolioPrices()}>Refresh Prices</button>
            <span className="muted tiny">Generate pie by price × quantity</span>
                  </div>
                </div>

                <div className="card">
                  <div className="row" style={{ justifyContent:'space-between' }}>
                    <div style={{ flex:'1 1 420px' }}>
            <div className="tiny muted">Holdings</div>
                      <table>
                        <thead>
                          <tr>
            <th>Symbol</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Market Value</th>
            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody>
                          {portfolio.length === 0 && (
            <tr><td colSpan="5" className="muted tiny">No holdings. Add above first.</td></tr>
                          )}
                          {portfolio.map((h)=> {
                            const priceObj = prices[h.symbol] || portfolioPrices[h.symbol] || {};
                            const price = priceObj.price;
                            const val = price ? price * h.quantity : 0;
                            return (
                              <tr key={h.symbol}>
                                <td className="symbol">{h.symbol}</td>
                                <td>{fmtNum(h.quantity, 0)}</td>
                                <td>{price ? fmtNum(price) : '-'}</td>
                                <td>{fmtNum(val)}</td>
            <td><button className="danger" onClick={()=>removeHolding(h.symbol)}>Remove</button></td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                      <div style={{ marginTop: 10 }}>
                        <button onClick={requestPortfolioDiagnostic} disabled={pfAiLoading || portfolio.length===0}>
            {pfAiLoading ? 'Diagnosing…' : 'AI Diagnostic'}
                        </button>
                        <span className="tiny muted" style={{ marginLeft: 10 }}>Portfolio checkup based on value weights</span>
                      </div>
                      {pfAnalysis && (
                        <div style={{ marginTop: 10 }}>
                          {pfAnalysis.error ? (
            <div className="tiny neg">Diagnostic failed: {String(pfAnalysis.error)}</div>
                          ) : (
                            <div className="details">
            <div className="tiny muted">AI Diagnostic Result</div>
                              <div className="row" style={{ gap: 16 }}>
                                <div>
            <div className="tiny muted">Diversity Score</div>
                                  <div>{pfAnalysis.analysis?.diversity_score ?? '-'}</div>
                                </div>
                                <div>
            <div className="tiny muted">Risk Level</div>
                                  <div>{pfAnalysis.analysis?.risk_level ?? '-'}</div>
                                </div>
                                <div>
            <div className="tiny muted">Max Single-Stock Weight</div>
                                  <div>{fmtPct(100*(pfAnalysis.analysis?.metrics?.single_stock_weight || 0))}</div>
                                </div>
                                <div>
            <div className="tiny muted">Sector Concentration</div>
                                  <div>{fmtPct(100*(pfAnalysis.analysis?.metrics?.sector_concentration || 0))}</div>
                                </div>
                                <div>
            <div className="tiny muted">Weighted Avg PE</div>
                                  <div>{pfAnalysis.analysis?.metrics?.avg_pe ?? '-'}</div>
                                </div>
                              </div>
                              {(pfAnalysis.analysis?.main_issues?.length || 0) > 0 && (
                                <div style={{ marginTop: 8 }}>
            <div className="tiny muted">Key Issues</div>
                                  <ul className="tiny">
                                    {pfAnalysis.analysis.main_issues.map((it, idx) => (<li key={idx}>{it}</li>))}
                                  </ul>
                                </div>
                              )}
                              {(pfAnalysis.analysis?.suggestions?.length || 0) > 0 && (
                                <div style={{ marginTop: 8 }}>
            <div className="tiny muted">Suggestions</div>
                                  <ul className="tiny">
                                    {pfAnalysis.analysis.suggestions.map((it, idx) => (<li key={idx}>{it}</li>))}
                                  </ul>
                                </div>
                              )}
                              {pfAnalysis.summary_text && (
                                <div style={{ marginTop: 8 }} className="tiny">
                                  {pfAnalysis.summary_text}
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                    <div className="chart-wrap" style={{ minWidth: 260, flex:'1 1 260px', height: 260 }}>
                      <canvas id="chart-portfolio"></canvas>
                    </div>
                  </div>
                </div>

                {/* 组合仪表板 */}
                <div className="card">
                  <div className="row" style={{ justifyContent:'space-between' }}>
                    <div style={{ flex:'1 1 420px' }}>
                  <div className="tiny muted">Weight Treemap</div>
                      <div className="chart-wrap" style={{ height: 260 }}>
                        <canvas id="chart-pf-treemap"></canvas>
                      </div>
                      <div className="tiny muted" style={{ marginTop: 8 }}>Based on holdings market value distribution</div>
                    </div>
                    <div className="chart-wrap" style={{ minWidth: 260, flex:'1 1 260px', height: 260 }}>
                      <div className="tiny muted">Risk Radar</div>
                      <canvas id="chart-pf-radar"></canvas>
                      <div className="tiny muted" style={{ marginTop: 8 }}>Depends on AI diagnostic metrics</div>
                    </div>
                  </div>
                  <div className="row" style={{ marginTop: 12, gap: 16 }}>
                    <div style={{ flex:'1 1 420px' }}>
            <div className="tiny muted">Correlation Heatmap</div>
                      <div id="pf-heatmap" style={{ overflow:'auto', maxHeight: 280 }}></div>
                    </div>
                    <div className="chart-wrap" style={{ minWidth: 260, flex:'1 1 260px', height: 260 }}>
                  <div className="tiny muted">Contribution Trend (Stacked Area)</div>
                      <canvas id="chart-pf-stacked"></canvas>
                    </div>
                  </div>
                  <div style={{ marginTop: 12 }}>
                  <button onClick={refreshPortfolioDashboard} disabled={portfolio.length===0}>Refresh Charts</button>
            <span className="tiny muted" style={{ marginLeft: 10 }}>Click refresh after changes to update data</span>
                  </div>
                </div>
              </>
            )}

            {tab === 'hot' && (
              <div className="card">
                <table>
                  <thead>
                    <tr>
            <th>Symbol</th>
            <th>Price</th>
            <th>Change %</th>
            <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {hot.map((p) => {
                      const chgPct = p.change_percent;
                      const cls = chgPct > 0 ? 'pos' : chgPct < 0 ? 'neg' : '';
                      return (
                        <tr key={p.symbol}>
                          <td className="symbol">{p.symbol}</td>
                          <td>{fmtNum(p.price)}</td>
                          <td className={cls}>{fmtPct(chgPct)}</td>
            <td><button onClick={()=>addSymbolDirect(p.symbol)}>Add to Watchlist</button></td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}

            {tab === 'indices' && (
              <div className="card">
                <div style={{ marginBottom: 8 }}>
            <span className="tiny muted" style={{ marginRight: 8 }}>Category</span>
            <button className={`tab ${idxCat==='global'?'active':''}`} onClick={()=>setIdxCat('global')}>Global Indices</button>
            <button className={`tab ${idxCat==='sector_etf'?'active':''}`} onClick={()=>setIdxCat('sector_etf')}>Sector ETFs</button>
                </div>
                <table>
                  <thead>
                    <tr>
            <th>Symbol</th>
            <th>Name</th>
            <th>Price</th>
            <th>Change %</th>
            <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {indices.map((idx) => {
                      const chgPct = idx.change_percent;
                      const cls = chgPct > 0 ? 'pos' : chgPct < 0 ? 'neg' : '';
                      const expanded = idxExpanded.has(idx.symbol);
                      const hasCons = Array.isArray(idx.constituents) && idx.constituents.length > 0;
                      return (
                        <React.Fragment key={idx.symbol}>
                          <tr>
                            <td className="symbol">{idx.symbol}</td>
                            <td>{idx.name}</td>
                            <td>{fmtNum(idx.price)}</td>
                            <td className={cls}>{fmtPct(chgPct)}</td>
                            <td>
                              {hasCons ? (
            <button onClick={()=>toggleIdxExpand(idx.symbol, idx.constituents)}>{expanded ? 'Hide Constituents' : 'Constituents'}</button>
                              ) : (
                                <span className="tiny muted">—</span>
                              )}
                            </td>
                          </tr>
                          {expanded && hasCons && (
                            <tr>
                              <td colSpan="5">
                                <div className="details">
            <div className="tiny muted">Constituent Stocks</div>
                                  <table style={{ width:'100%', marginTop:8 }}>
                                    <thead>
                                      <tr>
            <th>Symbol</th>
            <th>Price</th>
            <th>Change %</th>
            <th>Action</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {idx.constituents.map((sym) => {
                                        const cp = (idxConPrices[idx.symbol] || {})[sym] || {};
                                        const pct = cp.change_percent;
                                        const ccls = pct > 0 ? 'pos' : pct < 0 ? 'neg' : '';
                                        return (
                                          <tr key={sym}>
                                            <td className="symbol">{sym}</td>
                                            <td>{fmtNum(cp.price)}</td>
                                            <td className={ccls}>{fmtPct(pct)}</td>
            <td><button onClick={()=>addSymbolDirect(sym)}>Add to Watchlist</button></td>
                                          </tr>
                                        );
                                      })}
                                    </tbody>
                                  </table>
                                </div>
                              </td>
                            </tr>
                          )}
                        </React.Fragment>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}
            {showHelp && (
              <div className="modal-backdrop" onClick={closeHelp}>
                <div className="modal-content" onClick={(e)=>e.stopPropagation()}>
                  <h3>{HELP_MAP[helpKey]?.title || 'Indicator Help'}</h3>
                  <div className="tiny" style={{ marginTop:6 }}>{HELP_MAP[helpKey]?.def || 'No description available.'}</div>
                  <div className="tiny muted" style={{ marginTop:8 }}>{HELP_MAP[helpKey]?.meaning || ''}</div>
                  <div className="modal-actions">
                    <button onClick={closeHelp}>OK</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>